@model PropertyPageViewModel
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager
@using Aucsystem.Controllers;
@using Aucsystem.Models;

@{

    @if (Model?.Property != null)
    {
        ViewData["Title"] = $"{Model.Property.Name} - Property Details";
    }
    else
    {
        ViewData["Title"] = "Property Details";
    }    
    #pragma warning disable CS8604

    var currentUser = await UserManager.GetUserAsync(User);
    var isSeller = currentUser != null && currentUser.Id == @Model?.Property?.SellerId;
    var user = await UserManager.GetUserAsync(User);

}

<div class="container mt-5">
<div class="row border pt-4 pb-4 rounded">
        <div class="col-md-8">
            <div id="propertyCarousel" class="carousel mt-3 slide" data-bs-ride="carousel">
                <div class="carousel-indicators">
                    <button type="button" data-bs-target="#propertyCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                    @if (!string.IsNullOrEmpty(@Model?.Property?.ImageUrl2))
                    {
                        <button type="button" data-bs-target="#propertyCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
                    }
                    @if (!string.IsNullOrEmpty(@Model?.Property?.ImageUrl3))
                    {
                        <button type="button" data-bs-target="#propertyCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
                    }
                </div>
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="@Model?.Property?.ImageUrl1" class="d-block w-100 rounded" alt="@Model?.Property?.Name">
                    </div>
                    @if (!string.IsNullOrEmpty(@Model?.Property?.ImageUrl2))
                    {
                        <div class="carousel-item">
                            <img src="@Model.Property?.ImageUrl2" class="d-block w-100 rounded" alt="@Model?.Property?.Name">
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(@Model?.Property?.ImageUrl3))
                    {
                        <div class="carousel-item">
                            <img src="@Model.Property?.ImageUrl3" class="d-block w-100 rounded" alt="@Model.Property?.Name">
                        </div>
                    }
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-0 ">
                <div class="card-body">
                    <h1 class="fw-bold">@Model?.Property?.Name</h1>
                    <p class="text-muted">@Model?.Property?.Location</p>

                    <h3 class="text-primary">@DashboardController.FormatPrice(Model?.Property?.Price ?? 0)</h3>
                    <p class="mt-3">@Model?.Property?.Description</p>

                    @if (isSeller)
                    {
                        <a href="/Dashboard/EditProperty/@Model?.Property?.PropertyId" class="btn btn-warning w-100 mb-2">Edit Property</a>
                        <form method="post" action="/Dashboard/DeleteProperty" class="d-inline">
                            <input type="hidden" name="id" value="@Model?.Property?.PropertyId" />
                            <button type="submit" class="btn btn-danger w-100">Delete Property</button>
                        </form>
                    }
                    else
                    {
                        
                        <button class="btn btn-primary w-100" 
                            type="button" 
                            onclick="location.href='/Dashboard/PlaceBid/@Model?.Property?.PropertyId'">
                            Place your Bid
                        </button>
                        <div class="mt-2"></div>
                        <button class="btn btn-secondary w-100" 
                                onclick="location.href='/Dashboard/ContactSeller/@Model?.Seller?.Id'">
                            Contact Seller
                        </button>
               
                        
                    }
                </div>
            </div>
        </div>
    </div>


   <div class="mt-5 p-4 bg-gradient rounded">
    <h3 class="mb-3">Bids on this Property</h3>
        @if (Model?.Bids != null && Model.Bids.Any())
        {
                <table class="table rounded-3 table-bordered table-rounded">
                    <thead class="table-light">
                        <tr>
                            <th>Bidder Name</th>
                            <th>Bid Amount</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white">
                        @foreach (var bid in Model.Bids)
                        {
                            <tr>
                                <td>@(!string.IsNullOrEmpty(bid.BuyerName) ? bid.BuyerName : "Anonymous")</td>
                                <td>@bid.Amount.ToString("C")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p class="text-muted">No bids have been placed on this property yet.</p>
            }
        <br/>
        <h3 class="mb-3">Seller Information</h3>
        <div class="d-flex align-items-center">
            <div class="me-2">
                @if (!string.IsNullOrEmpty(@Model?.Seller?.ProfilePicture))
                {
                     <img src="@Model?.Seller?.ProfilePicture" width="52" height="55" alt="@Model?.Seller?.FullName" class="rounded-circle me-2" style="object-fit: cover;"  />
                }
                else
                {
                    <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center text-white" style="width: 52px; height: 55px; font-size: 18px;">
                        @if (!string.IsNullOrEmpty(@Model?.Seller?.FullName))
                        {
                            @string.Join("", @Model.Seller.FullName.Split(' ').Select(word => word[0]))
                        }
                       
                    </div>
                }
            </div>
        
            <div class="mt-3">
                <h4 class="mb-1 align-items-center">
                    @Model?.Seller?.FullName
                    @if (@Model?.TotalProperties >= 3)
                    {
                        <img src="/images/verified.png" alt="Verified" width="22" height="22" class="">
                    }
                </h4>
                <p class="text-muted">@Model?.Seller?.Email</p>
            </div>
        </div>
        <p class="mt-3"><strong>Total Properties Listed:</strong> @Model?.TotalProperties</p>
    </div>

<style>
    .carousel-inner img {
        height: 390px; 
        object-fit: cover; 
        width: 100%;
    }
     .row {
        border: 1px solid #f4f4f4; 
        border-radius: 8px; 
        padding-left: 16px;
        padding-right: 16px;

    }
    .bg-white tbody tr {
        background-color: #ffffff !important;
    }

    .table-bordered td, .table-bordered th {
        border: 1px solid #dee2e6; 
    }
    table.table{
        border-radius: 11px;
    }

</style>